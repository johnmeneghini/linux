# Call Graph for fc_rport_set_marginal_state Function

## Overview
`fc_rport_set_marginal_state` is a sysfs device attribute store function in the FC (Fibre Channel) transport layer that allows userspace to change the state of FC remote ports between Online and Marginal states.

**Location**: `drivers/scsi/scsi_transport_fc.c:1222`

## Call Graph

### Callers (Top-down)
```
Userspace
│
├── write() system call to /sys/class/fc_rport/rport-X:Y-Z/port_state
│
├── VFS layer (fs/sysfs/)
│   └── sysfs_kf_write()
│       └── dev_attr_store()
│           └── device_attr_rport_port_state.store()
│               └── fc_rport_set_marginal_state()  ← TARGET FUNCTION
```

### Function Implementation Analysis
```c
static ssize_t fc_rport_set_marginal_state(struct device *dev,
                                          struct device_attribute *attr,
                                          const char *buf, size_t count)
```

### Direct Function Calls (Callees)
```
fc_rport_set_marginal_state()
├── transport_class_to_rport(dev)
│   └── dev_to_rport(dev->parent)  [macro in include/scsi/scsi_transport_fc.h:398]
│       └── container_of(dev->parent, struct fc_rport, dev)
│
└── get_fc_port_state_match(buf, &port_state)
    └── [Generated by fc_enum_name_match macro at line 168]
    └── Searches fc_port_state_names[] table for string match
        └── strncmp() [from standard library]
```

## Detailed Analysis

### 1. Function Registration Chain
```
fc_attach_transport()
├── Setup rport attributes
│   └── SETUP_PRIVATE_RPORT_ATTRIBUTE_RW(port_state)  [line 2716]
│       └── Creates device_attr_rport_port_state
│           └── FC_DEVICE_ATTR(rport, port_state, 0444|0200, 
│               show_fc_rport_port_state, fc_rport_set_marginal_state)
│               └── __ATTR(port_state, 0644, show_func, store_func)
│
└── transport_container_register(&i->rport_attr_cont)  [line 2631]
    └── Registers attributes with sysfs
```

### 2. Macro Expansions

#### FC_DEVICE_ATTR Macro (line 66):
```c
#define FC_DEVICE_ATTR(_prefix,_name,_mode,_show,_store)
struct device_attribute device_attr_##_prefix##_##_name = 
    __ATTR(_name,_mode,_show,_store)
```

#### fc_enum_name_match Macro (line 85):
```c
#define fc_enum_name_match(title, table_type, table)
static int get_fc_##title##_match(const char *table_key, enum table_type *value)
{
    // Searches through table array comparing strings
    for (i = 0; i < ARRAY_SIZE(table); i++) {
        if (strncmp(table_key, table[i].name, table[i].matchlen) == 0) {
            *value = table[i].value;
            return 0; /* success */
        }
    }
    return 1; /* failure */
}
```

### 3. Data Structures Used
```
fc_port_state_names[] table (lines 153-166):
├── FC_PORTSTATE_UNKNOWN     → "Unknown"
├── FC_PORTSTATE_NOTPRESENT  → "Not Present"  
├── FC_PORTSTATE_ONLINE      → "Online"      ← Valid transition target
├── FC_PORTSTATE_OFFLINE     → "Offline"
├── FC_PORTSTATE_BLOCKED     → "Blocked"
├── FC_PORTSTATE_BYPASSED    → "Bypassed"
├── FC_PORTSTATE_DIAGNOSTICS → "Diagnostics"
├── FC_PORTSTATE_LINKDOWN    → "Linkdown"
├── FC_PORTSTATE_ERROR       → "Error"
├── FC_PORTSTATE_LOOPBACK    → "Loopback"
├── FC_PORTSTATE_DELETED     → "Deleted"
└── FC_PORTSTATE_MARGINAL    → "Marginal"    ← Valid transition target
```

## Function Behavior

### Allowed State Transitions
1. **Online → Marginal**: Allowed
2. **Marginal → Online**: Allowed  
3. **Any other transitions**: Rejected with -EINVAL

### Error Cases
- Invalid input string → -EINVAL
- Attempt to transition from/to invalid states → -EINVAL
- get_fc_port_state_match() failure → -EINVAL

## Sysfs Interface

**Path**: `/sys/class/fc_rport/rport-X:Y-Z/port_state`
**Permissions**: 0644 (read/write for owner, read for group/others)
**Usage**:
```bash
# Read current state
cat /sys/class/fc_rport/rport-2:0-1/port_state

# Set to marginal (if currently online)
echo "Marginal" > /sys/class/fc_rport/rport-2:0-1/port_state

# Set to online (if currently marginal)  
echo "Online" > /sys/class/fc_rport/rport-2:0-1/port_state
```

## Integration Points
- **SCSI Transport Layer**: Part of FC transport template registration
- **Device Model**: Integrated with Linux device model via transport containers
- **Sysfs**: Exposes FC remote port state management to userspace
- **FC Drivers**: Used by FC HBA drivers for remote port state management

## Files Involved
1. `drivers/scsi/scsi_transport_fc.c` - Main implementation
2. `include/scsi/scsi_transport_fc.h` - Header with macro definitions  
3. `/sys/class/fc_rport/` - Sysfs interface exposure
